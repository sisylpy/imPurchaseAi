

function getAttrName(string){
  if (string) {
    var string = string.toString(string);
    if(string.length > 3){

    string = string.substring(0, 3);
    string = string + "..."
    return string;
    }else{
      return string;
    }
    
  }
}

function getDifferentPrice(a){
  return Math.abs(a);

}

function getAttrDateString(string){
  if (string) {
    var string = string.toString(string);
    var  month = string.substring(5, 7);
   var monthFirst =  month.substring(0,1);
   if(monthFirst == '0'){
     month =  string.substring(6, 7);
   }
    var  date = string.substring(8, 10);

    return month + "月" + date + "日";
    
  }
}


function getGongli(a,b){
  var bbb  = a / 1000;
  return  bbb.toFixed(b);
}

function getPercent(a, b){
  var c = ((a/b) * 100).toFixed(1) ;
  return c;
}
function getProfitPercent(a,b){
  var c =(((b - a) / a) * 100 ).toFixed(1)
  return c;
}


function getAttrDate(string){
  if (string) {
    var string = string.toString(string);
    string = string.substring(5, 10);
  
    return string; 
  }
}


function getAttrFullTime(string){
  if (string) {
    var string = string.toString(string);
    string = string.substring(5, 16);
    return string; 
  }
}

function getAttrString(string, from, long){
  if (string) {
    var string = string.toString(string);
    string = string.substring(from, long);
    return string; 

  }
}


function transferDateString(date){
  date =  date.substring(5);
  var str =  date.split("-");
  var dateString = ""
  if(str.length  == 2){
    var yue = str[0];
    var ri = str[1];
    yue  =  Number(yue);
    ri  = Number(ri);
    dateString = yue + "月" + ri +"日"
  }
  return  dateString ;
}

function getProducePercent(a,b){
  if(b !== 0){
    var  abc = (a / b * 100).toFixed(2);
    return  abc;
  }else{
    return 0;
  }
}


function getCostTotal(a,b,c){
  // 将字符串参数转换为数字，处理空值或无效值
  // WXS 不支持 Number() 函数，使用一元加号操作符
  var numA = +a || 0;
  var numB = +b || 0;
  var numC = +c || 0;
  
  // 计算总和
  var total = numA + numB + numC;
  
  // 检查是否为有效数字
  if (isNaN(total)) {
    return '0.0';
  }
  
  var rounded = Math.round(total * 100) / 100;
  
  // 转换为字符串并确保有一位小数
  var str = rounded.toString();
  var dotIndex = str.indexOf('.');
  
  if (dotIndex === -1) {
    // 没有小数点，添加 .0
    str = str + '.0';
  } else if (dotIndex === str.length - 2) {
    // 已经是一位小数，不需要添加
  } else if (dotIndex === str.length - 1) {
    // 只有小数点，添加0
    str = str + '0';
  }
  
  return str;
}

function transferDateTimeString(date){
  date =  date.substring(5);
  var str =  date.split("-");
  var time = str[1].split(" ");
  var dateString = ""
  if(str.length  == 2){
    var yue = str[0];
    var ri = time[0];
    var clock = time[1];
    yue  =  Number(yue);
    ri  = Number(ri);
    colock = Number(clock)
    dateString = yue + "月" + ri +"日" + " " + clock
  }
  return  dateString ;
}


function transferFullTimeString(date){
  date =  date.substring(0, 10);
  var str =  date.split("-");
  var dateString = ""
    var nian = str[0];
    var yue = str[1];
    var ri = str[2];
    yue  =  Number(yue);
    ri  = Number(ri);
    dateString = nian + "年" +  yue + "月" + ri +"日" 
  
  return  dateString ;
}


function getCompareTime(startTime, endTime){
  if(startTime && endTime){
 var  endTimeFormat =endTime.replace(getRegExp('-','g'),'/');
  var endTimeDown = Date.parse(getDate(endTimeFormat)); 
  var  startTimeFormat =startTime.replace(getRegExp('-','g'),'/');
  var startTimeDown = Date.parse(getDate(startTimeFormat)); 
  var  thisResult =  endTimeDown -  startTimeDown;
     thisResult =  Math.floor(thisResult / 1000 / 60 / 60)
  
  return thisResult;

  }
  
}

function getCompareTimeSecond(startTime, endTime){
  if(startTime && endTime){
  
  var  thisResult =  startTime -  endTime;
     thisResult =  Math.floor(thisResult / 1000 / 60 / 60)
  return thisResult;

  }
}

function changeDateStyleDot(dateStr){

  return  dateStr.split("-").join(".");;
}

// 判断采购批次供货商是否在选择的供货商列表中，返回颜色
function getSupplierPriceColor(supplierId, selectedSupplierIds) {
  // 如果供货商ID为-1（没有关联供货商），则不显示特殊颜色
  if (!supplierId || supplierId === -1 || !selectedSupplierIds || selectedSupplierIds === -1) {
    return '#333'; // 默认颜色
  }
  
  // 将选择的供货商ID字符串转换为数组
  var supplierIdArray = selectedSupplierIds.toString().split(',');
  
  // 检查当前供货商ID是否在选择的列表中
  for (var i = 0; i < supplierIdArray.length; i++) {
    if (supplierIdArray[i] == supplierId) {
      return '#4CAF50'; // 绿色，表示匹配
    }
  }
  
  return '#333'; // 默认颜色，表示不匹配
}

// 判断采购员是否在选择的采购员列表中，返回颜色
function getPurchaseUserColor(purchaseUserId, selectedPurchaseUserIds) {
  if (!purchaseUserId || !selectedPurchaseUserIds || selectedPurchaseUserIds === -1) {
    return '#333'; // 默认颜色
  }
  
  // 将选择的采购员ID字符串转换为数组
  var purchaseUserIdArray = selectedPurchaseUserIds.toString().split(',');
  
  // 检查当前采购员ID是否在选择的列表中
  for (var i = 0; i < purchaseUserIdArray.length; i++) {
    if (purchaseUserIdArray[i] == purchaseUserId) {
      return '#FF6B35'; // 橙色，与采购员筛选器颜色保持一致
    }
  }
  
  return '#333'; // 默认颜色，表示不匹配
}

// 判断单价颜色，同时参考供货商和采购员
function getPriceColor(supplierId, purchaseUserId, selectedSupplierIds, selectedPurchaseUserIds) {
  var hasSupplierMatch = false;
  var hasPurchaseUserMatch = false;
  
  // 检查供货商是否匹配
  if (supplierId && supplierId !== -1 && selectedSupplierIds && selectedSupplierIds !== -1) {
    var supplierIdArray = selectedSupplierIds.toString().split(',');
    for (var i = 0; i < supplierIdArray.length; i++) {
      if (supplierIdArray[i] == supplierId) {
        hasSupplierMatch = true;
        break;
      }
    }
  }
  
  // 检查采购员是否匹配
  if (purchaseUserId && selectedPurchaseUserIds && selectedPurchaseUserIds !== -1) {
    var purchaseUserIdArray = selectedPurchaseUserIds.toString().split(',');
    for (var i = 0; i < purchaseUserIdArray.length; i++) {
      if (purchaseUserIdArray[i] == purchaseUserId) {
        hasPurchaseUserMatch = true;
        break;
      }
    }
  }
  
  // 如果供货商ID为-1（没有关联供货商），返回默认色
  if (supplierId === -1) {
    return '#333'; // 默认颜色
  }
  
  // 供货商ID有实际值时的逻辑
  if (hasSupplierMatch && hasPurchaseUserMatch) {
    return '#9B59B6'; // 紫色，表示供货商和采购员都匹配
  } else if (hasSupplierMatch) {
    return '#4CAF50'; // 绿色，表示只有供货商匹配
  } else if (hasPurchaseUserMatch) {
    return '#FF6B35'; // 橙色，表示只有采购员匹配
  } else {
    return '#333'; // 默认颜色，表示都不匹配
  }
}

// 判断供货商是否匹配，返回布尔值
function isSupplierMatch(supplierId, selectedSupplierIds) {
  if (!supplierId || !selectedSupplierIds || selectedSupplierIds === -1) {
    return false;
  }
  
  var supplierIdArray = selectedSupplierIds.toString().split(',');
  for (var i = 0; i < supplierIdArray.length; i++) {
    if (supplierIdArray[i] == supplierId) {
      return true;
    }
  }
  return false;
}

// 判断采购员是否匹配，返回布尔值
function isPurchaseUserMatch(purchaseUserId, selectedPurchaseUserIds) {
  if (!purchaseUserId || !selectedPurchaseUserIds || selectedPurchaseUserIds === -1) {
    return false;
  }
  
  var purchaseUserIdArray = selectedPurchaseUserIds.toString().split(',');
  for (var i = 0; i < purchaseUserIdArray.length; i++) {
    if (purchaseUserIdArray[i] == purchaseUserId) {
      return true;
    }
  }
  return false;
}



function getRestTime(startTime, endTime){
  if(startTime && endTime){
    // 处理不完整的时间格式，如果缺少秒数，添加 ":00"
    var processedEndTime = endTime;
    var processedStartTime = startTime;
    
    // 如果 endTime 只有日期和时间，没有秒数，添加 ":00"
    if(endTime.length === 16 && endTime.indexOf(':') !== -1 && endTime.lastIndexOf(':') === endTime.indexOf(':')) {
      processedEndTime = endTime + ":00";
    }
    
    // 如果 startTime 只有日期和时间，没有秒数，添加 ":00"
    if(startTime.length === 16 && startTime.indexOf(':') !== -1 && startTime.lastIndexOf(':') === startTime.indexOf(':')) {
      processedStartTime = startTime + ":00";
    }
    
    // 格式化时间字符串，将 '-' 替换为 '/'
    var endTimeFormat = processedEndTime.replace(getRegExp('-','g'),'/');
    var startTimeFormat = processedStartTime.replace(getRegExp('-','g'),'/');
    
    // 转换为时间戳（毫秒）
    var endTimeDown = Date.parse(getDate(endTimeFormat)); 
    var startTimeDown = Date.parse(getDate(startTimeFormat)); 
    
    // 检查时间戳是否有效
    if(isNaN(endTimeDown) || isNaN(startTimeDown)) {
      return 0;
    }
    
    // 计算剩余时间（毫秒）：过期时间 - 当前时间
    var thisResult = endTimeDown - startTimeDown;
    thisResult = Math.floor(thisResult / 1000 / 60 / 60);
    console.log("resusus", thisResult)
    return thisResult;
  }
  return 0;
}

// 计算已超过废弃多少小时（当前时间 - 废弃时间）
function getHaveWasteHours(nowTime, wasteTime){
  if(nowTime && wasteTime){
    // 处理不完整的时间格式，如果缺少秒数，添加 ":00"
    var processedNowTime = nowTime;
    var processedWasteTime = wasteTime;
    
    // 如果 nowTime 只有日期和时间，没有秒数，添加 ":00"
    if(nowTime.length === 16 && nowTime.indexOf(':') !== -1 && nowTime.lastIndexOf(':') === nowTime.indexOf(':')) {
      processedNowTime = nowTime + ":00";
    }
    
    // 如果 wasteTime 只有日期和时间，没有秒数，添加 ":00"
    if(wasteTime.length === 16 && wasteTime.indexOf(':') !== -1 && wasteTime.lastIndexOf(':') === wasteTime.indexOf(':')) {
      processedWasteTime = wasteTime + ":00";
    }
    
    // 格式化时间字符串，将 '-' 替换为 '/'
    var nowTimeFormat = processedNowTime.replace(getRegExp('-','g'),'/');
    var wasteTimeFormat = processedWasteTime.replace(getRegExp('-','g'),'/');
    
    // 转换为时间戳（毫秒）
    var nowTimeStamp = Date.parse(getDate(nowTimeFormat)); 
    var wasteTimeStamp = Date.parse(getDate(wasteTimeFormat)); 
    
    // 检查时间戳是否有效
    if(isNaN(nowTimeStamp) || isNaN(wasteTimeStamp)) {
      return 0;
    }
    
    // 计算已超过时间（毫秒）：当前时间 - 废弃时间
    var wasteHours = nowTimeStamp - wasteTimeStamp;
    wasteHours = Math.floor(wasteHours / 1000 / 60 / 60);
    
    return wasteHours;
  }
  return 0;
}


function transferCouponTimeString(date){
  date =  date.substring(5);
  var str =  date.split("-");
  var time = str[1].split(" ");
  var dateString = ""
  if(str.length  == 2){
    var yue = str[0];
    var ri = time[0];
    var clock = time[1];
    yue  =  Number(yue);
    ri  = Number(ri);
    clock =  clock.substring(0,5);
    colock = Number(clock);
    dateString = yue + "月" + ri +"日" + " " + clock
  }
  return  clock ;
}


function transferCouponDateString(date){
  date =  date.substring(5);
  var str =  date.split("-");
  var time = str[1].split(" ");
  var dateString = ""
  if(str.length  == 2){
    var yue = str[0];
    var ri = time[0];
    var clock = time[1];
    yue  =  Number(yue);
    ri  = Number(ri);
    clock =  clock.substring(0,5);
    colock = Number(clock);
    dateString = yue + "月" + ri +"日" 
  }
  return  dateString ;
}

// 根据日期字符串计算星期几
function getWeekDay(dateString) {
  if (!dateString) {
    return '';
  }
  
  // 将日期字符串转换为Date对象
  // 格式: "2025-08-01"
  var dateFormat = dateString.replace(getRegExp('-','g'),'/');
  var date = getDate(dateFormat);
  
  // 获取星期几 (0-6, 0是星期日)
  var dayOfWeek = date.getDay();
  
  // 转换为中文星期
  var weekDays = ['星期日', '星期一', '星期二', '星期三', '星期四', '星期五', '星期六'];
  
  return weekDays[dayOfWeek];
}

// 从日期字符串中提取日期号数
function getDayNumber(dateString) {
  if (!dateString) {
    return '';
  }
  
  // 格式: "2025-08-01" -> 提取 "01"
  var day = dateString.substring(8, 10);
  
  // 去掉前导零，如 "01" -> "1"
  if (day.charAt(0) === '0') {
    day = day.charAt(1);
  }
  
  return day;
}

// 获取月日格式，如 "9月1日"
function getMonthDay(dateString) {
  if (!dateString) {
    return '';
  }
  
  // 格式: "2025-08-01" -> 提取月份和日期
  var month = dateString.substring(5, 7);
  var day = dateString.substring(8, 10);
  
  // 去掉前导零
  if (month.charAt(0) === '0') {
    month = month.charAt(1);
  }
  if (day.charAt(0) === '0') {
    day = day.charAt(1);
  }
  
  return month + '月' + day + '日';
}

// 获取日期范围
function getDateRange(rangeType) {
  if (!rangeType) {
    return { startDate: '', stopDate: '' };
  }
  
  var today = getDate();
  var year = today.getFullYear();
  var month = today.getMonth() + 1; // 0-11 转为 1-12
  var date = today.getDate();
  
  // 格式化日期为 YYYY-MM-DD
  function formatDate(d) {
    var y = d.getFullYear();
    var m = d.getMonth() + 1;
    var day = d.getDate();
    return y + '-' + (m < 10 ? '0' + m : m) + '-' + (day < 10 ? '0' + day : day);
  }
  
  var startDate = '';
  var stopDate = '';
  
  switch (rangeType) {
    case 'today':
      startDate = stopDate = formatDate(today);
      break;
      
    case 'yesterday':
      var yesterday = getDate(today.getTime() - 24 * 60 * 60 * 1000);
      startDate = stopDate = formatDate(yesterday);
      break;
      
    case 'thisWeek':
      // 获取本周一
      var dayOfWeek = today.getDay();
      var daysToMonday = dayOfWeek === 0 ? -6 : 1 - dayOfWeek; // 周日为0，需要-6天到周一
      var thisWeekStart = getDate(today.getTime() + daysToMonday * 24 * 60 * 60 * 1000);
      startDate = formatDate(thisWeekStart);
      
      // 获取本周日（本周最后一天）
      var daysToSunday = dayOfWeek === 0 ? 0 : 7 - dayOfWeek; // 如果今天是周日，则不需要调整
      var thisWeekEnd = getDate(today.getTime() + daysToSunday * 24 * 60 * 60 * 1000);
      stopDate = formatDate(thisWeekEnd);
      
      console.log('=== thisWeek 日期计算 (utils/fn.wxs) ===');
      console.log('今天:', formatDate(today), '星期', dayOfWeek);
      console.log('本周一:', startDate);
      console.log('本周日:', stopDate);
      console.log('=====================================');
      break;
      
    case 'lastWeek':
      // 获取上周一
      var dayOfWeek = today.getDay();
      var daysToLastMonday = dayOfWeek === 0 ? -13 : -6 - dayOfWeek;
      var lastWeekStart = getDate(today.getTime() + daysToLastMonday * 24 * 60 * 60 * 1000);
      startDate = formatDate(lastWeekStart);
      
      // 获取上周日
      var lastWeekEnd = getDate(lastWeekStart.getTime() + 6 * 24 * 60 * 60 * 1000);
      stopDate = formatDate(lastWeekEnd);
      break;
      
    case 'lastSevenDays':
      // 过去7天（不包括今天）
      var sevenDaysAgo = getDate(today.getTime() - 7 * 24 * 60 * 60 * 1000);
      startDate = formatDate(sevenDaysAgo);
      
      var yesterday = getDate(today.getTime() - 24 * 60 * 60 * 1000);
      stopDate = formatDate(yesterday);
      break;
      
    case 'thisMonth':
      // 本月第一天
      var thisMonthStart = getDate(year + '-' + (month < 10 ? '0' + month : month) + '-01');
      startDate = formatDate(thisMonthStart);
      
      // 结束时间是今天
      stopDate = formatDate(today);
      break;
      
    case 'lastMonth':
      // 上月第一天
      var lastMonth = month === 1 ? 12 : month - 1;
      var lastYear = month === 1 ? year - 1 : year;
      var lastMonthStart = getDate(lastYear + '-' + (lastMonth < 10 ? '0' + lastMonth : lastMonth) + '-01');
      startDate = formatDate(lastMonthStart);
      
      // 上月最后一天 - 使用本月第一天减去一天
      var thisMonthFirst = getDate(year + '-' + (month < 10 ? '0' + month : month) + '-01');
      var lastMonthEnd = getDate(thisMonthFirst.getTime() - 24 * 60 * 60 * 1000);
      stopDate = formatDate(lastMonthEnd);
      break;
      
    case 'lastThirtyDays':
      // 从上个月的今天到今天的日期
      var lastMonthToday = getDate(today.getTime());
      lastMonthToday.setMonth(lastMonthToday.getMonth() - 1);
      startDate = formatDate(lastMonthToday);
      
      stopDate = formatDate(today);
      
      // 打印日志验证
      console.log('=== lastThirtyDays 日期计算 ===');
      console.log('今天日期:', formatDate(today));
      console.log('上个月今天:', formatDate(lastMonthToday));
      console.log('开始日期:', startDate);
      console.log('结束日期:', stopDate);
      console.log('===============================');
      break;
      
    default:
      startDate = stopDate = '';
  }
  
  // 获取中文名称
  var chineseName = '';
  switch (rangeType) {
    case 'today':
      chineseName = '今天';
      break;
    case 'yesterday':
      chineseName = '昨天';
      break;
    case 'thisWeek':
      chineseName = '本周';
      break;
    case 'lastWeek':
      chineseName = '上周';
      break;
    case 'lastSevenDays':
      chineseName = '过去7天';
      break;
    case 'thisMonth':
      chineseName = '本月';
      break;
    case 'lastMonth':
      chineseName = '上月';
      break;
    case 'lastThirtyDays':
      chineseName = '过去30天';
      break;
    default:
      chineseName = rangeType;
  }

  return {
    startDate: startDate,
    stopDate: stopDate,
    name: chineseName
  };
}

// 计算从指定日期到今天多少天
function getHowManyDays(targetDate) {
  if (!targetDate) {
    return 0;
  }
  
  // 处理不同格式的日期字符串
  var dateStr = targetDate.toString();
  
  // 如果是 YYYY-MM-DD 格式，直接使用
  if (dateStr.match(getRegExp('^\\d{4}-\\d{2}-\\d{2}$'))) {
    var target = getDate(dateStr);
  } else {
    // 尝试解析其他格式
    target = getDate(dateStr);
  }
  
  // 检查日期是否有效
  if (isNaN(target.getTime())) {
    return 0;
  }
  
  var today = getDate();
  
  // 重置时间为00:00:00，只比较日期部分
  today.setHours(0, 0, 0, 0);
  target.setHours(0, 0, 0, 0);
  
  // 计算时间差（毫秒）
  var timeDiff = today.getTime() - target.getTime();
  
  // 转换为天数
  var daysDiff = Math.floor(timeDiff / (1000 * 60 * 60 * 24));
  
  return daysDiff;
}

// 将日期时间字符串转换为"9月30日23点39分"格式
function formatDateTimeToChinese(dateTimeString) {
  if (!dateTimeString) {
    return '';
  }
  
  // 处理格式: "2025-09-30 23:39"
  var dateTimeStr = dateTimeString.toString();
  
  // 分割日期和时间部分
  var parts = dateTimeStr.split(' ');
  if (parts.length !== 2) {
    return '';
  }
  
  var datePart = parts[0]; // "2025-09-30"
  var timePart = parts[1];  // "23:39"
  
  // 分割日期
  var dateArray = datePart.split('-');
  if (dateArray.length !== 3) {
    return '';
  }
  
  var year = dateArray[0];
  var month = dateArray[1];
  var day = dateArray[2];
  
  // 分割时间
  var timeArray = timePart.split(':');
  if (timeArray.length < 2) {
    return '';
  }
  
  var hour = timeArray[0];
  var minute = timeArray[1];
  
  // 去掉前导零
  if (month.charAt(0) === '0') {
    month = month.charAt(1);
  }
  if (day.charAt(0) === '0') {
    day = day.charAt(1);
  }
  if (hour.charAt(0) === '0') {
    hour = hour.charAt(1);
  }
  if (minute.charAt(0) === '0') {
    minute = minute.charAt(1);
  }
  
  // 组合成中文格式
  return month + '月' + day + '日' + hour + '点' + minute + '分';
}




module.exports = {
  getGongli:getGongli,
  getPercent: getPercent,
  getProfitPercent:getProfitPercent,
  getAttrName: getAttrName,
  getAttrDate: getAttrDate,
  getAttrFullTime: getAttrFullTime,
  transferDateString: transferDateString,
  transferDateTimeString: transferDateTimeString,
  transferFullTimeString: transferFullTimeString,
  getAttrString: getAttrString,
  getAttrDateString: getAttrDateString,
  getProducePercent: getProducePercent,
  getCompareTime: getCompareTime,
  getRestTime: getRestTime,
  getHaveWasteHours: getHaveWasteHours,
  getDifferentPrice: getDifferentPrice,
  changeDateStyleDot: changeDateStyleDot,
  transferCouponTimeString: transferCouponTimeString,
  transferCouponDateString: transferCouponDateString,
  getSupplierPriceColor: getSupplierPriceColor,
  getPurchaseUserColor: getPurchaseUserColor,
  getPriceColor: getPriceColor,
  getCostTotal: getCostTotal,
  getCompareTimeSecond: getCompareTimeSecond,
  getWeekDay: getWeekDay,
  getDayNumber: getDayNumber,
  getMonthDay: getMonthDay,
  getDateRange: getDateRange,
  getHowManyDays: getHowManyDays,
  formatDateTimeToChinese: formatDateTimeToChinese

}