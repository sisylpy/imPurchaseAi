<wxs src="../../../../utils/fn.wxs" module="tool" />


<view class="flex flex-column">
 
  
  <back-navbar style="height: {{navBarHeight}}rpx;" title="{{disGoods.gbDgGoodsName}}" avatar="/images/back-gray.png" button-text="设置" bindnavbuttontap="toBack"></back-navbar>



  <!--  top -->
  <view class=" flex-row-between pl-20 pr-20 border-bottom bg-white">
    <view class="flex-row">
      <view class="p-20" bindtap="toDatePage">
        <image src="../../../../images/calender.png" class="icon"></image>
      </view>
      <view class="flex-column pt-10">
        <view class="font-yuan">{{hanzi}}</view>
        <view class="flex-row" wx:if="{{startDate == stopDate}}">
          <view class=" small" wx:if="{{startDate}}"> {{tool.transferDateString(startDate)}}</view>
        </view>
        <view class="flex-row" wx:else>
          <view class="" wx:if="{{startDate}}"> {{tool.transferDateString(startDate)}}</view>
          <text class="plr-10">-</text>
          <view class="" wx:if="{{stopDate}}">{{tool.transferDateString(stopDate)}}</view>
        </view>
      </view>
    </view>

    <view class="flex-row p-20" bindtap="toFilterType">
      <image src="{{searchDepId !== -1 ? '../../../../images/filter.png' : '../../../../images/filter-3-fill.png'}}" class="icon mr-20"></image>
    </view>
  </view>


  <view class="flex-column" wx:if="{{arr.length > 0}}">
 
 <view class="bg-white p-20" style="height: 400rpx;">
      <view wx:if="{{itemList.length > 0}}" style="height: 360rpx;">
        <ec-canvas id="dailyChart" canvas-id="dailyChart" style="width: 100%; height: 100%;">
        </ec-canvas> 
      </view>
      <view wx:else class="no-data-text" style="height: 360rpx; display: flex; align-items: center; justify-content: center;">
        <text>暂无图表数据</text>
      </view>
    </view>


  <view class="flex-column p-20">
    
 <!-- 采购详情 -->
 <view class="flex-column purchase-row-container">

<view class="flex-column mt-10 {{purIndex == selectedPurIndex ? 'pur-selected' : ''}}" wx:for="{{arr}}" wx:for-item="pur" wx:for-index="purIndex" wx:key="gbDistributerPurchaseGoodsId" bind:tap="showDetail" data-goods-index="{{index}}" data-pur-index="{{purIndex}}" id="pur-item-{{purIndex}}">

    <!-- 采购批次默认显示 - 蓝色主题 -->
    <view class="flex-row purchase-row {{pur.expanded ? 'purchase-row-active' : ''}}">

      <!-- 左侧时间 -->
      <view class="flex-row mr-20">
        <view class="flex-column" >
          <view class="font-md flex-row">{{tool.transferDateString(pur.gbDpgStockFinishDate)}}</view>
          <block wx:if="{{pur.purchaseDepartmentUser !== null}}">
            <text class="purchase-type">自采</text>
        </block>
        <block wx:else="">
            <text class="purchase-type">订货</text>
        </block>
        </view>
      </view>
      <!-- 中间采购信息 -->
      <view class="flex-column" style="flex: 1;">
        <view class="flex-row-between">
          <text class="font-bold">{{pur.gbDpgBuyQuantity}}{{disGoods.gbDgGoodsStandardname}}</text>
          <text class="purchase-info-value-amount mr-20">{{pur.gbDpgBuySubtotal}}元</text>
        </view>
        <view class="flex-row-between mt-5">
          <text class="purchase-date">{{pur.gbDpgBuyPrice}}元/{{disGoods.gbDgGoodsStandardname}}</text>
          <block wx:if="{{pur.purchaseDepartmentUser !== null}}">
            <text class="purchase-date mr-20">{{pur.purchaseDepartmentUser.gbDuWxNickName}}</text>
          </block>
          <block wx:elif="{{pur.nxJrdhSupplierEntity !== null}}">
            <text class="purchase-date mr-20">{{pur.nxJrdhSupplierEntity.nxJrdhsSupplierName}}</text>
          </block>

        </view>
      </view>

      <!-- 右侧箭头 -->
      <view class="flex-column-center">
        <image src="/images/arrow-right-3.png" mode="aspectFill" class="arrow-icon {{pur.expanded ? 'expanded' : 'collapsed'}}" style="width: 24rpx; height: 24rpx;" />
      </view>

    </view>

    <!-- 采购详细信息 - 蓝色主题 -->
    <view wx:if="{{pur.expanded}}" class="purchase-info-card expandable-content expanded">

      <!-- 图标 + 标题 -->
      <view class="purchase-info-header">
        <view class="flex-row-between">
          <view class="flex-row">
            <image src="../../../../images/kucun.png" class="purchase-info-header-icon"></image>
            <text class="purchase-info-header-title">入库详细信息</text>
          </view>
          <!-- <image src="/images/search.png" mode="aspectFill" class="icon p-10" /> -->
        </view>
      </view>

      <!-- 采购详细信息 -->
      <view class="purchase-detail-section" wx:for="{{pur.gbDepartmentGoodsStockEntities}}" wx:for-item="stock"  >

        <view class="purchase-info-item">
          <text class="purchase-info-label">采购部门</text>
          <text class="purchase-info-value">{{stock.gbDepartmentEntity.gbDepartmentName}}</text>
        </view>

        <view class="purchase-info-item">
          <text class="purchase-info-label">入库数量</text>
          <text class="purchase-info-value">{{stock.gbDgsWeight}}{{disGoods.gbDgGoodsStandardname}}</text>
        </view>
        <view class="purchase-info-item">
          <text class="purchase-info-label">入库单价</text>
          <text class="purchase-info-value">{{stock.gbDgsPrice}}元/{{disGoods.gbDgGoodsStandardname}}</text>
        </view>
        <view class="purchase-info-item">
          <text class="purchase-info-label">入库金额</text>
          <text class="purchase-info-value">{{stock.gbDgsSubtotal}}元</text>
        </view>
        <view class="purchase-info-item">
          <text class="purchase-info-label">现库存</text>
          <text class="purchase-info-value">{{stock.gbDgsRestWeight}}{{disGoods.gbDgGoodsStandardname}}</text>
        </view>

        <view class="purchase-info-item">
          <text class="purchase-info-label">销售</text>
          
          <text class="purchase-info-value">{{stock.gbDgsProduceWeight}}{{disGoods.gbDgGoodsStandardname}}</text>

        </view>
        <view class="purchase-info-item">
          <text class="purchase-info-label">损耗</text>
          <text class="purchase-info-value">{{stock.gbDgsLossWeight}}{{disGoods.gbDgGoodsStandardname}}</text>
        </view>
        <view class="purchase-info-item">
          <text class="purchase-info-label">废弃</text>
          <text class="purchase-info-value">{{stock.gbDgsWasteWeight}}{{disGoods.gbDgGoodsStandardname}}</text>
        </view>
        <view class="purchase-info-item">
          <text class="purchase-info-label">退货</text>
          <text class="purchase-info-value">{{stock.gbDgsReturnWeight}}{{disGoods.gbDgGoodsStandardname}}</text>
        </view>
      </view>
    </view>

</view>
</view>
<!--  -->


  </view>


  </view>


  <!-- </block> -->

  <view class="{{arr.length == 0 ? 'show' : 'hide'}}" style="height: {{windowHeight - 360}}rpx;">

    <view class="center-content flex-column" style="padding-top: 200rpx;">
      <image class="empty_image" src="/images/cart-Empty.png"></image>
      <text class="big">无数据</text>
    </view>

  </view>
  <!-- ./empty -->

</view>

<!-- 日期不匹配提示弹窗 -->
<view wx:if="{{showDateModal}}" class="modal-mask" bindtap="closeDateModal">
  <view class="modal-dialog" bindtap="stopPropagation">
    <view class="modal-title">查询周期不匹配</view>
    <view class="modal-content">
      <view class="modal-message">
        <text>您要查询的采购批次日期为：</text>
        <text class="highlight-text">{{tool.transferDateString(purchaseDate)}}</text>
      </view>
      <view class="modal-message">
        <text>当前查询周期为：</text>
        <text class="highlight-text">{{tool.transferDateString(startDate)}} 至 {{tool.transferDateString(stopDate)}}</text>
      </view>
      <view class="modal-tip">
        <text>该采购批次不在当前查询周期内，建议修改查询周期以查看该批次数据。</text>
      </view>
    </view>
    <view class="modal-buttons">
      <view class="modal-button cancel-button" bindtap="closeDateModal">取消</view>
      <view class="modal-button confirm-button" bindtap="goToDateSetting">去设置</view>
    </view>
  </view>
</view>


