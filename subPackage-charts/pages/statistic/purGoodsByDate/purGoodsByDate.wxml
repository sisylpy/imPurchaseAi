<wxs src="../../../../utils/fn.wxs" module="tool" />


<view class="flex flex-column">

  <block wx:if="{{greatId != -1}}">
   
  <back-navbar title="{{name}}" style="height: {{navBarHeight}}rpx;" avatar="/images/back-gray.png" button-text="设置" bindnavbuttontap="toBack"></back-navbar>
  </block>

  <block wx:else="">
    

  <back-navbar title="{{value}}元" style="height: {{navBarHeight}}rpx;" avatar="/images/back-gray.png" button-text="设置" bindnavbuttontap="toBack"></back-navbar>
  </block>


  <!--  search-top -->
  <view class=" flex-row-between pl-20 pr-20 border-bottom bg-white">
    <view class="flex-row">
      <view class="p-20" bindtap="toDatePageSearch">
        <image src="../../../../images/calender.png" class="icon"></image>
      </view>
      <view class="flex-column pt-10">
        <view class="font-yuan">{{hanzi}}</view>
        <view class="flex-row" wx:if="{{startDate == stopDate}}">
          <view class=" small" wx:if="{{startDate}}"> {{tool.transferDateString(startDate)}}</view>
        </view>
        <view class="flex-row" wx:else>
          <view class="" wx:if="{{startDate}}"> {{tool.transferDateString(startDate)}}</view>
          <text class="plr-10">-</text>
          <view class="" wx:if="{{stopDate}}">{{tool.transferDateString(stopDate)}}</view>
        </view>
      </view>
    </view>

    <view class="flex-row p-20" bindtap="toFilterType">
      <image src="{{searchDepId !== -1 ? '../../../../images/filter.png' : '../../../../images/filter-3-fill.png'}}" class="icon mr-20"></image>
    </view>
  </view>

  <view class="page-container" wx:if="{{arr.length > 0}}">
    <scroll-view scroll-y="true" bindscrolltolower="onReachBottom" bindscroll="onScroll" style="background-color: #f5f5f5; height: {{scrollViewHeight}}rpx;">


      <!-- 顶部统计卡片 -->
      <view class="stats-container">
        <view class="stat-card purchase-card" bind:tap="onTab1Click" data-type="0" data-index="0" hover-class="hover">
          <view class="stat-title">自采</view>
          <view class="stat-value">{{zicai}}元</view>
          <view class="stat-details">
            <view class="stat-subtitle">商品{{zicaiCount}}个</view>
          </view>
        </view>
        <view class="stat-card total-card" bind:tap="onTab1Click" data-type="1" data-index="1" hover-class="hover">
          <view class="stat-title">订货</view>
          <view class="stat-value">{{dinghuo}}元</view>
          <view class="stat-details">
            <view class="stat-subtitle">商品{{dinghuoCount}}个</view>
          </view>
        </view>
        <view class="stat-card ratio-card" bind:tap="onTab1Click" data-type="2" data-index="2" hover-class="hover">
          <view class="stat-title">库存</view>
          <view class="stat-value">{{stockTotal}}元</view>
          <view class="stat-details">
            <view class="stat-subtitle">商品{{stockCount}}个</view>
          </view>
        </view>
      </view>


      <view class="flex-column  bg-white">

        <!-- 商品详情卡片 -->
        <view class="flex-column border-bottom p-20" wx:for-item="goods" wx:key="gbDistributerGoodsId" wx:for="{{arr}}" id="goods-container-{{index}}">

          <!-- 商品信息头部 -->
          <view class="flex-row-between" bind:tap="showList" data-index="{{index}}">
            <view class="flex-row-default mb-20">
              <image bindtap="showDialogBtn" data-item="{{goods}}" src="{{url + goods.gbDgNxFatherImg}}" mode="aspectFill" class="goods-image mr-20" />
              <view class="flex-column">
                <text class="font-sm">第{{index + 1}}名/共{{totalCount}}个</text>
                <view class="flex-row mb-10">
                  <text class="font-bold mr-10">{{goods.gbDgGoodsName}}</text>
                  <block wx:if="{{goods.gbDgGoodsStandardWeight.length > 0}}">
                    <text class="text-secondary font-xs">({{goods.gbDgGoodsStandardWeight}}/{{goods.gbDgGoodsStandardname}})</text>
                  </block>
                  <block wx:else>
                    <text class="text-secondary font-xs">({{goods.gbDgGoodsStandardname}})</text>
                  </block>
                </view>

              </view>

            </view>

            <!-- 右侧总计和按钮 -->
            <view class="goods-price-section">
              <view class="price-container">
                <text class="price-label">采购</text>
                <text class="price-value">¥{{goods.gbDgSellingPrice}}</text>
              </view>
              <!-- 右侧箭头 -->
              <view class="arrow-container {{goods.showPurchaseList ? 'expanded' : 'collapsed'}}">
                <image src="/images/arrow-right-3.png" mode="aspectFill" class="arrow-icon" style="width: 24rpx; height: 24rpx;" />
              </view>
            </view>
          </view>


          <!-- 采购详情 -->
          <!-- 采购批次列表 - 默认隐藏，点击showList后显示 -->
          <view class="flex-column purchase-row-container expandable-content {{goods.showPurchaseList ? 'expanded' : ''}}">

            <view class="flex-column " wx:for="{{goods.wastePurGoodsEntities}}" wx:for-item="pur" wx:for-index="purIndex" catch:tap="showDetail" data-goods-index="{{index}}" data-pur-index="{{purIndex}}">

              <!-- 采购批次默认显示 - 蓝色主题 -->
              <view class="flex-row purchase-row {{pur.expanded ? 'purchase-row-active' : ''}}">

                <!-- 左侧时间 -->
                <view class="flex-row mr-20">
                  <view class="flex-column">
                    <view class="font-md flex-row">{{tool.transferDateString(pur.gbDpgStockFinishDate)}}</view>
                    <block wx:if="{{pur.purchaseDepartmentUser !== null}}">
                      <text class="purchase-type">自采</text>
                    </block>
                    <block wx:else="">
                      <text class="purchase-type">订货</text>
                    </block>
                  </view>
                </view>
                <!-- 中间采购信息 -->
                <view class="flex-column" style="flex: 1;">
                  <view class="flex-row-between">
                    <text class="font-bold">{{pur.gbDpgBuyQuantity}}{{goods.gbDgGoodsStandardname}}</text>
                    <text class="purchase-info-value-amount mr-20">{{pur.gbDpgBuySubtotal}}元</text>
                  </view>
                  <view class="flex-row-between mt-5">
                    <text class="purchase-date">{{pur.gbDpgBuyPrice}}元/{{goods.gbDgGoodsStandardname}}</text>
                    <block wx:if="{{pur.purchaseDepartmentUser !== null}}">
                      <text class="purchase-date mr-20">{{pur.purchaseDepartmentUser.gbDuWxNickName}}</text>
                    </block>
                    <block wx:elif="{{pur.nxJrdhSupplierEntity !== null}}">
                      <text class="purchase-date mr-20">{{pur.nxJrdhSupplierEntity.nxJrdhsSupplierName}}</text>
                    </block>

                  </view>
                </view>

                <!-- 右侧箭头 -->
                <view class="flex-column-center">
                  <image src="/images/arrow-right-3.png" mode="aspectFill" class="arrow-icon {{pur.expanded ? 'expanded' : 'collapsed'}}" style="width: 24rpx; height: 24rpx;" />
                </view>

              </view>


              <!-- 修改最新的库存样式！ -->
              <!-- 采购详细信息 - 蓝色主题 -->
              <view wx:if="{{pur.expanded}}" class="purchase-info-card expandable-content expanded">



                <!-- 库存详细信息 -->
                <view class="purchase-detail-section" wx:for="{{pur.gbDepartmentGoodsStockEntities}}" wx:for-item="stock">

                  <!-- 库存信息行布局 -->
                  <view class="stock-info-row">
                    <!-- 左侧：部门信息 -->
                    <view class="stock-department-info">
                      <text class="font-bold">{{stock.gbDepartmentEntity.gbDepartmentName}}</text>
                    </view>

                    <!-- 右侧：金额信息对比 -->
                    <view class="stock-comparison-container">
                      <!-- 入库信息 -->
                      <view class="stock-info-column stock-inbound">
                        <view class="column-label">入库</view>
                        <view class="column-content">
                          <text class="amount-text">{{stock.gbDgsSubtotal}}元</text>
                          <text class="weight-text">{{stock.gbDgsWeight}}{{goods.gbDgGoodsStandardname}}</text>
                        </view>
                      </view>

                      <!-- 分隔线 -->
                      <view class="comparison-divider"></view>

                      <!-- 剩余信息 -->
                      <view class="stock-info-column stock-rest">
                        <view class="column-label">剩余</view>
                        <view class="column-content">
                          <text class="amount-text rest-amount">{{stock.gbDgsRestSubtotal}}元</text>
                          <text class="weight-text rest-weight">{{stock.gbDgsRestWeight}}{{goods.gbDgGoodsStandardname}}</text>
                        </view>
                      </view>
                    </view>
                  </view>

                </view>
              </view>

            </view>
          </view>
          <!--  -->

        </view>

        <!-- 分页提示-->
        <view class="font-sm center-content flex-column p-20" wx:if="{{arr.length > 0}}">
          <view class="flex-row">
            <text class="text-secondary">共 {{totalCount}} 条记录，第 {{currentPage}}/{{totalPage}} 页</text>
          </view>
          <view class="flex-row mt-10" wx:if="{{currentPage < totalPage}}">
            <text class="text-secondary">上拉加载更多</text>
          </view>
          <view class="flex-row mt-10" wx:if="{{currentPage >= totalPage}}">
            <text class="text-secondary">已加载全部数据</text>
          </view>
        </view>

        <view class="font-sm center-content flex-column " wx:if="{{currentPage == totalPage}}">
          <view class="flex-row">
            <image src="{{url + '/userImage/daodile3.png'}}" mode="aspectFill" class="icon-lg margin-right" />
            <view style="line-height: 200rpx;">没有数据啦!</view>
          </view>

        </view>
      </view>

    </scroll-view>
  </view>


  <!-- </block> -->

  <view class="{{arr.length == 0 ? 'show' : 'hide'}}" style="height: {{windowHeight - 360}}rpx;">

    <view class="center-content flex-column" style="padding-top: 200rpx;">
      <image class="empty_image" src="/images/cart-Empty.png"></image>
      <text class="big">无数据</text>
    </view>

  </view>
  <!-- ./empty -->

</view>